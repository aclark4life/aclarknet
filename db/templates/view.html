{% extends 'dashboard/index.html' %}
{% block dashboard_title %}
  {% include 'title_block.html' %}
{% endblock %}
{% block dashhead_title %}
  <h2 class="dashhead-title">
    <a class="text-decoration-none text-secondary"
       href="{% url model_name|add:'_index' %}">{{ model_name_plural|title }}</a>
    <i class="fa-solid fa-angle-right"></i> {{ model_name|title }}
  </h2>
{% endblock %}
{% block dashboard %}
  {% include 'toolbars/index.html' %}
  {% if model_name == 'invoice' %}
    {% include 'accordion-invoice.html' %}
  {% endif %}
  {% load babel humanize tz text_filters %}
  <div class="accordion my-3" id="accordionDetail">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="list-group-item list-group-item-action justify-content-between d-flex fw-semibold p-3 accordion-button"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseDetail"
                aria-expanded="true"
                aria-controls="collapseDetail">Detail</button>
      </h2>
      <div id="collapseDetail"
           class="accordion-collapse {% if model_name == 'invoice' %}collapse{% else %}show{% endif %}"
           data-bs-parent="#accordionDetail">
        <div class="accordion-body p-0">
          <table class="table table-striped my-0">
            <tbody>
              {% for field_name, field_value in field_values %}
                <tr>
                  <th>{{ field_name|title_case }}</th>
                  <td>
                    {% if field_name == 'description' and model_name == 'note' and field_value %}
                      <div class="d-flex align-items-start gap-2">
                        <div class="flex-grow-1" id="description-text">{{ field_value|format_field_value:field_name }}</div>
                        <button class="btn btn-sm btn-outline-secondary" type="button" id="copy-description-btn" title="Copy description">
                          <i class="fa-solid fa-copy"></i>
                        </button>
                      </div>
                    {% else %}
                      {{ field_value|format_field_value:field_name }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% if object_notes or user.is_superuser %}
    <div class="accordion my-3" id="accordionNotes">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="list-group-item list-group-item-action justify-content-between d-flex fw-semibold p-3 accordion-button"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseNotes"
                  aria-expanded="true"
                  aria-controls="collapseNotes">
            Notes <span class="mx-1 badge text-bg-dashboard text-white">{{ object_notes|length|default:"0" }}</span>
          </button>
        </h2>
        <div id="collapseNotes"
             class="accordion-collapse collapse"
             data-bs-parent="#accordionNotes">
          <div class="accordion-body">
            {% if user.is_superuser %}
              <div class="mb-3">
                <a href="{% url 'note_add_to_object' %}?content_type={{ content_type.id }}&object_id={{ object.pk }}"
                   class="btn btn-outline-dashboard btn-sm">
                  <i class="fa-solid fa-plus"></i> Add Note
                </a>
              </div>
            {% endif %}
            {% if object_notes %}
              {% for note in object_notes %}
                <div class="card mb-3"
                     onclick="window.location='{% url 'note_view' note.id %}'"
                     style="cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;"
                     onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';"
                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                  <div class="card-body">
                    {% if note.name %}
                      <h5 class="card-title">{{ note.name }}</h5>
                    {% endif %}
                    <p class="card-text">{{ note.text|linebreaks }}</p>
                    <div class="text-muted small">
                      {% if note.user %}
                        <i class="fa-solid fa-user"></i> {{ note.user.username }} â€¢
                      {% endif %}
                      <i class="fa-solid fa-clock"></i> {{ note.created|date:"SHORT_DATETIME_FORMAT" }}
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">No notes yet. Click "Add Note" to create one.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}
  {% if model_name == 'invoice' and user_calculations %}
    {% include 'total.html' %}
  {% endif %}
  {% if has_related and user.is_superuser %}
    {% include 'related.html' %}
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const copyButton = document.getElementById('copy-description-btn');
      if (copyButton) {
        copyButton.addEventListener('click', function() {
          const descriptionText = document.getElementById('description-text');
          const textToCopy = descriptionText.textContent.trim();

          navigator.clipboard.writeText(textToCopy).then(function() {
            // Change button appearance temporarily to show success
            const originalHTML = copyButton.innerHTML;
            copyButton.innerHTML = '<i class="fa-solid fa-check"></i>';
            copyButton.classList.remove('btn-outline-secondary');
            copyButton.classList.add('btn-success');

            setTimeout(function() {
              copyButton.innerHTML = originalHTML;
              copyButton.classList.remove('btn-success');
              copyButton.classList.add('btn-outline-secondary');
            }, 2000);
          }).catch(function(err) {
            console.error('Failed to copy text: ', err);
            alert('Failed to copy description. Please copy it manually.');
          });
        });
      }
    });
  </script>
{% endblock %}
